#!/bin/bash
set -eu

BASE=$(dirname $0)/../
BRBM=brbm${1:-''}

# Only add brbm if missing
(sudo ovs-vsctl list-br | grep ${BRBM}"$") || sudo ovs-vsctl add-br ${BRBM}

# remove brbm before replacing it.
(virsh net-list --all --persistent | grep ${BRBM}" ") && (
 virsh net-destroy ${BRBM}; virsh net-undefine ${BRBM})
scripts/configure-brbm --name ${BRBM}
virsh net-autostart ${BRBM}
virsh net-start ${BRBM}

# start default if needed and configure it to autostart
default_net=$(sudo virsh net-list --all --persistent | grep default | awk 'BEGIN{OFS=":";} {print $2,$3}')
state=${default_net%%:*}
autostart=${default_net##*:}

if [ "$state" != "active" ]; then
  virsh net-start default
fi

if [ "$autostart" != "yes" ]; then
  virsh net-autostart default
fi

