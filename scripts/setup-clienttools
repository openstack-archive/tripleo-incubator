#!/bin/bash
set -eu

BASE=$(readlink -f $(dirname $0)/..)

virtualenv --setuptools $BASE/openstack-tools
set +u
. $BASE/openstack-tools/bin/activate
set -u

# If custom PyPI mirrors are configured for the pypi DIB element
# use them here also.
MIRROR_URLS=$(compgen -A variable | grep PYPI_MIRROR_URL)
for MIRROR_URL in ${MIRROR_URLS}
do
    echo ${MIRROR_URL}=${!MIRROR_URL}
    PIP_OPTIONS="${PIP_OPTIONS:-""} --index-url=${!MIRROR_URL}"
done

# Need setuptools>=1.0 to manage connections when
# downloading from pypi using http_proxy and https_proxy
pip install ${PIP_OPTIONS} -U 'setuptools>=1.0'

# bug #1293812 : Avoid easy_install triggering on pbr as easy_install is
# fragile.
pip install ${PIP_OPTIONS} -U 'pbr>=0.5.21,<1.0'

pip install ${PIP_OPTIONS} -U python-cinderclient python-novaclient python-glanceclient python-heatclient python-keystoneclient python-neutronclient python-swiftclient python-ironicclient python-openstackclient os-apply-config

for tool in os-apply-config cinder nova glance heat keystone neutron swift ironic openstack; do
  ln -sf $BASE/openstack-tools/bin/$tool $BASE/scripts/$tool ;
done
echo "Installed openstack client tool symlinks in $BASE/scripts"
