#!/bin/bash
set -eu

BASE=$(readlink -f $(dirname $0)/..)
VENV_HOME=$BASE/openstack-tools

if [ ! -f $VENV_HOME/bin/activate ]; then
  virtualenv --setuptools $VENV_HOME
fi

# NOTE(derekh): we need to use +u to workaround an issue with the activate script
# /opt/stack/new/tripleo-incubator/openstack-tools/bin/activate: line 8: _OLD_VIRTUAL_PATH: unbound variable
set +u
source $VENV_HOME/bin/activate
set -u

# Need setuptools>=1.0 to manage connections when
# downloading from pypi using http_proxy and https_proxy
pip install -U 'setuptools>=1.0'

# bug #1293812 : Avoid easy_install triggering on pbr as easy_install is
# fragile.
pip install -U 'pbr>=0.5.21,<1.0'

pip install -U python-cinderclient python-novaclient python-glanceclient python-heatclient python-keystoneclient python-neutronclient python-swiftclient python-ironicclient python-openstackclient os-apply-config os-cloud-config

# If we're testing os-apply-config or os-cloud-config, we want the version
# under test.
echo "<<< HERE >>>"
echo "ZUUL_REF: $ZUUL_REF"
echo "ZUUL_PROJECT: $ZUUL_PROJECT"
echo "ZUUL_CHANGE: $ZUUL_CHANGE"
echo "ZUUL_PATCHSET: $ZUUL_PATCHSET"

for tool in os-apply-config cinder nova glance heat keystone neutron swift ironic openstack init-keystone; do
  ln -sf $VENV_HOME/bin/$tool $BASE/scripts/$tool ;
done
echo "Installed openstack client tool symlinks in $BASE/scripts"
