#!/bin/bash
set -eu

CPU=$1
MEM=$2
DISK=$3
NODES=$4

if [ -z "$NODES" ]; then
  NODES="all"
fi

count=0
for MAC in $MACS; do
    count=$((count + 1))
    if [ $NODES = "undercloud" -a $count -eq 1 ]; then
        # Skip the first node - allocated for use by the seed cloud.
        continue
    fi
    nova baremetal-node-create $NODES $CPU $MEM $DISK $MAC

    # Power management settings are optional and only used for real bare metal.
    if [ -n "$PM_IPS" -a -n "$PM_USERS" -a -n "$PM_PASSWORDS" ]; then
        IPS=( $PM_IPS )
        USERS=( $PM_USERS )
        PASSWORDS=( $PM_PASSWORDS )
        nova baremetal-node-create --pm_address=${IPS[$count]} --pm_user=${USERS[$count]} --pm_password=${PASSWORDS[$count]} $NODES $CPU $MEM $DISK $MAC
    else
        nova baremetal-node-create $NODES $CPU $MEM $DISK $MAC
    fi

    if [ $NODES = "seed" ]; then
        # Only allocate one node for underclouds.
        break
    fi
done
date
echo "Nodes will be available in 60 seconds from now."
