#!/bin/bash
set -eu

CPU=$1
MEM=$2
DISK=$3
NODES=$4

if [ -z "$NODES" ]; then
  NODES="all"
fi

count=0

# Power management settings are optional and only used for real bare metal.
ips=( $PM_IPS )
users=( $PM_USERS )
passwords=( $PM_PASSWORDS )

for MAC in $MACS; do
    count=$((count + 1))
    if [ $NODES = "undercloud" -a $count -eq 1 ]; then
        # Skip the first node - allocated for use by the seed cloud.
        continue
    fi
    nova baremetal-node-create $NODES $CPU $MEM $DISK $MAC

    if [ -n "$PM_IPS" -a -n "$PM_USERS" -a -n "$PM_PASSWORDS" ]; then
        nova baremetal-node-create --pm_address=${ips[$count]} --pm_user=${users[$count]} --pm_password=${passwords[$count]} $NODES $CPU $MEM $DISK $MAC
    else
        nova baremetal-node-create $NODES $CPU $MEM $DISK $MAC
    fi

    if [ $NODES = "seed" ]; then
        # Only allocate one node for underclouds.
        break
    fi
done
date
echo "Nodes will be available in 60 seconds from now."
